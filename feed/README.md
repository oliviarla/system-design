# 뉴스 피드 서비스
> 링크드인, 트위터와 같은 뉴스 피드 서비스를 구현해본 프로젝트입니다.
> 가장 간단한 형태의 사용자, 피드, 뉴스피드, 팔로잉/팔로워 기능을 구현했습니다.
## 기술 스택

### DB

- ScyllaDB
  - 대량의 쓰기, 읽기, 시간 순 정렬에 최적화되어 있다. 트위터같은 서비스의 경우 쓰기 요청 비율이 높기 때문에 쓰기 성능이 중요하므로 이를 최우선으로 고려하였다.
  - Clustering Key를 기반으로 데이터를 정렬된 형태로 저장하며 저지연을 목표로 설계되어있어 시간 순으로 범위 조회할 때 다른 DB에 비해 성능이 좋다.
- Redis
  - 뉴스 피드, 팔로잉/팔로워 카운트, 최근 피드 저장소로 사용한다.

### Messaging

- Kafka

### Server

- Spring Boot Webflux
- Spring Cloud Gateway
- Spring Security
- Spring Session Data Redis

## 서비스 구성
### 유저 서비스
- 회원가입/로그인/로그아웃
    - 사용자 생성이 가능하다.
    - 사용자 인증 및 인가를 수행한다.
- 팔로우 / 언팔로우
    - 다른 유저를 팔로우하거나 언팔로우할 수 있다.
        - 팔로우
            - ScyllaDB `following_by_user`, `follower_by_user` 테이블에 데이터 추가
            - Kafka event 발행 → 유저의 뉴스피드 캐시 최신화 (새롭게 팔로우한 사람의 피드 추가)
        - 언팔로우
            - ScyllaDB `following_by_user`, `follower_by_user` 테이블의 데이터 제거
            - Kafka event 발행 → 유저의 뉴스피드 캐시 최신화 (팔로우 취소한 사람의 피드 제거)
        - ScyllaDB에 오류 발생한 경우 예외를 던진다.

### 피드 서비스
- 피드를 발행할 수 있다.
    - 피드는 기본적으로 ScyllaDB에 저장한다. 사용자의 최근 작성 게시물들을 담아둔 Redis ZSET 아이템이 있다면 데이터를 추가한다.
    - 최대 300자 글자로만 작성할 수 있다.
    - 피드의 ID는 ScyllaDB, Redis에서 사용하기 용이한 Snowflake 타입으로 생성한다.
      - ScyllaDB에서 피드 ID를 기준으로 정렬하면 시간 순으로 정렬된다.
      - 또한 Redis ZSET의 score로도 중복 없이 사용할 수 있다.
  - 새로 작성된 피드 ID와 회원 ID는 카프카에 전달하여 뉴스피드 fan-out이 수행되도록 한다.
  - 특정 회원이 작성한 최신 피드의 목록은 Redis ZSET에 캐싱한다. 갱신할 때 마다 TTL을 7일으로 연장한다.
    ```
    - key: "feed:{userId}"
    - score: feedId
    - member: feedId
    ```
- 특정 회원이 작성한 피드 목록을 조회할 수 있다. 무한 스크롤 페이징 방식으로 제공하며, lastFeedId 인자를 사용해 다음 페이지로 넘어갈 수 있다.

### 뉴스피드 서비스
- 조회
  - lastFeedId, size 인자를 받아 팔로잉 중인 회원의 게시글 조합을 최신순으로 조회한다.
  - 무한스크롤 형태로 조회 가능하다. 기본적으로 한 스크롤 당 10개의 게시글이 제공된다.
  - 뉴스피드는 계속 스크롤해도 계속 팔로잉 중인 유저들의 예전글이 나와야 한다.
      - 캐시에서 더 이상 뉴스피드 데이터를 조회할 수 없다면 DB에서 데이터를 조합해보고 다시 조회한다.
  - 조회 시 뉴스 피드 데이터가 없다면 새로 구축한다. 뉴스피드 정보는 항상 캐시에 저장해두고 조회한다.
    - 뉴스 피드 데이터를 저장할 캐시 아이템의 구조는 다음과 같다.
      ```
      key: "newsfeed:{usedId}"
      zscore: feedId
      value: username + ':' + feedId
      ```

- 뉴스 피드 데이터 구축
  - **뉴스 피드 캐시 아이템 자체가 없을 때**
    - 최초로 계정을 생성했거나, 자주 서비스를 이용하지 않거나, Redis 장애로 아이템이 사라진 경우, 뉴스 피드 캐시 아이템이 없을 수 있다.
    - 이 경우 fan-in 과정을 통해 새롭게 뉴스 피드 아이템을 생성해야 한다.
    - 뉴스 피드 아이템 생성 과정은 다음과 같다.
      1. 사용자의 팔로잉 수가 1000 이상인 경우 100개씩 청크 단위로 나누어 팔로잉 유저 목록을 조회하고, 그 외의 경우 모든 팔로잉 유저 목록을 조회한다. 
      2. 각 유저마다 현재 시간으로부터 1일 동안 작성한 피드 목록을 조회하여 유저의 뉴스 피드 목록에 `ZADD` 한다.
      3. 만약 `ZCOUNT`를 통해 얻은 뉴스 피드 캐시 아이템의 원소 개수가 30개 이하라면, 지금까지의 과정을 2회 더 반복한다. (지금으로부터 최대 3일 전까지의 데이터를 조회해본다.)
      4. `ZREVRANGE` 명령을 보내 사용자가 원하는 구간의 피드 아이디 목록을 얻는다.
  - **뉴스 피드 캐시 아이템이 존재할 때**
      - 뉴스 피드 캐시 아이템이 있더라도 팔로워가 매우 많은 인플루언서를 팔로우하고 있다면, fan-out 과정에서 뉴스 피드 캐시에 피드가 추가되지 않는다.
      - 사용자가 맨 첫 페이지를 요청한 경우 fan-out에서 추가되지 못한 피드에 한해 fan-in하는 작업을 거친다.
          1. 사용자의 팔로잉 목록 중 팔로워가 매우 많은 인플루언서를 필터링한다. 팔로잉하는 인플루언서 수가 1000 이상인 경우 100개씩 청크 단위로 나누어 팔로잉 유저 목록을 조회하고, 그 외의 경우 모든 팔로잉 유저 목록을 조회한다.
          2. 인플루언서 유저의 경우 최신 피드 목록을 항상 최신화 상태로 캐싱해두기 때문에 이를 활용하여 1일 간의 데이터를 조회하여 뉴스 피드 목록에 `ZADD` 한다.
          3. 만약 `ZCOUNT`를 통해 얻은 뉴스 피드 캐시 아이템의 원소 개수가 30개 이하라면, 지금까지의 과정을 2회 더 반복한다. (지금으로부터 최대 3일 전까지의 데이터를 조회해본다.)
          4. `ZREVRANGE` 명령을 보내 사용자가 원하는 구간의 피드 아이디 목록을 얻는다.
      - `ZREVRANGE` 결과가 `size` 인자보다 작을 때에도 fan-in 작업 한다.
          1. 기존 newsfeed 아이템 피드 중 가장 작은 lastFeedId를 구한다.
          2. 사용자의 팔로잉 목록을 돌면서 lastFeedId 이하이면서  피드들을 조회한다.

### 팬아웃 서비스

- 피드가 발행되었을 때 카프카 토픽에 보낸 메시지를 조회(poll)하여 팬아웃 작업을 수행한다.
- **fan-out**
    1. 피드를 발행한 유저의 팔로워 숫자를 조회한다.
    2. 팔로워 숫자가 매우 많은 경우(1만 이상) 팬아웃 작업을 스킵한다. 그 외의 경우 다음 작업을 진행한다.
    3. 팔로워 목록을 조회한다.
    4. 각 팔로워의 뉴스 피드 캐시에 피드 ID를 삽입한다. redis `EXISTS → ZADD` 명령을 lua script로 수행하여 뉴스 피드 캐시가 기존에 없다면 추가하지 않는다.
    5. 실패한 작업은 Resilience4j 사용하여 재시도하고 최종적으로 실패한 경우 Dead Letter Queue로 보낸다.

### 게이트웨이 서비스

- 사용자의 요청을 받아 적절한 서비스로 위임해주는 게이트웨이
- Spring Session Data Redis 의존성을 가지도록 하여 사용자의 쿠키에 있는 데이터와 Redis에 보낸 요청을 조합하여 요청에 대한 세션 정보를 파악한다.
    - 세션 정보가 파악된 요청은 실제 서비스에 전달될 때 내부적으로 생성한 JWT를 전달한다. 이를 통해 각 서비스들마다 Spring Session Data Redis 의존성을 가지지 않고도 어떤 권한을 가진 유저가 요청을 보냈는지 확인할 수 있다. 내부적으로 생성한 JWT는 외부 사용자에게 전달되면 안된다.
    - 세션 정보가 없는 요청은 그대로 실제 서비스에 전달된다.
- 로그인, 로그아웃 기능은 User Service에 위임한다.

### 배치 서비스
- 뉴스 피드 아이템 크기 제한
    - Redis에 저장된 뉴스 피드 ZSET 아이템이 일정 크기(현재는 50개 제한)를 초과하는 경우, 오래된 피드를 제거한다.

## 향후 계획

- 리포스트, 코멘트, 인용 기능을 지원
- 이미지를 함께 포스트 할 수 있도록 지원
- 모듈 간 내부 통신을 RPC로 전환
- Session 인증 방식을 JWT로 전환
